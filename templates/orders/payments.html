{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
<div class="container">

<!-- ============================ COMPONENT 1 ================================= -->

<div class="row">
  <h4 class="text-center">Review Your Order And Make Payment</h4>
	<aside class="col-lg-8">
    <div class="card">
  <h5 class="card-header">Billing Address</h5>
  <div class="card-body">
    <p class="card-text mb-4">{{ order.full_name }}<br></p>
    <p class="card-text mb-4">{{ order.address_line_1 }}<br>
    {% if order.address_line_2 %}{{ order.address_line_2 }}<br>{% endif %}</p>
    <p class="card-text mb-4">{{ order.city }}, {{ order.state }}, {{ order.country }}<br></p>
    <p class="card-text mb-4">{{ order.phone }}<br></p>
    <p class="card-text mb-4">{{ order.email }}<br></p>
    
    {% if order.order_note %}
     <b>Order Note: {{ order.order_note }}</b>
    {% endif %}
  </div>
</div>
<div class="card">
  <h5 class="card-header">Payment Method</h5>
  <div class="card-body">
    <p class="card-text">Cash On Delivery</p>
  </div>
</div>
<div class="card">
  <h5 class="card-header">Review Products</h5>
  <div class="card-body">
    <table class="table table-borderless table-shopping-cart">
      <thead>
        <tr class="text-muted small text-uppercase">
          <th scope="col">PRODUCT</th>
          <th scope="col" class="text-center">QUANTITY</th>
          <th scope="col" class="text-right">PRICE</th>
        </tr>
      </thead>
      <tbody>
        {% for cart_item in cart_items %}
        <tr>
          <td>
            <div class="d-flex align-items-center">
              <img src="{{ cart_item.product.images.url }}" class="checkout-product-img mr-3" alt="{{ cart_item.product.product_name }}" style="width: 60px; height: auto;">
              <div>
                <h6 class="mb-1">{{ cart_item.product.product_name }}</h6>
                {% if cart_item.variations.all %}
                  {% for item in cart_item.variations.all %}
                    <small class="text-muted">{{ item.variation_category|capfirst }} : {{ item.variation_value|capfirst }}</small><br>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </td>
          <td class="text-center align-middle">
            {{ cart_item.quantity }}
          </td>
          <td class="text-right align-middle">
            <strong>Rs. {{ cart_item.sub_total }}</strong><br>
            <small class="text-muted">Rs. {{ cart_item.product.price }} each</small>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
	</aside> <!-- col.// -->
	<aside class="col-lg-4">
		<div class="card">
		<div class="card-body">
			<dl class="dlist-align">
			  <dt>Total price:</dt>
			  <dd class="text-right">Rs. {{ total }}</dd>
			</dl>
			<dl class="dlist-align">
			  <dt>Tax:</dt>
			  <dd class="text-right">Rs. {{ tax }}</dd>
			</dl>
			<dl class="dlist-align">
			  <dt>Total:</dt>
			  <dd class="text-right text-dark b"><strong>Rs. {{ grand_total }}</strong></dd>
			</dl>
			<hr>
			<p class="text-center mb-3">
				<img src="{% static './images/misc/payments.png' %}" height="26">
			</p>
			
			<!-- Cash on Delivery Button -->
			<form action="{% url 'cash_on_delivery' %}" method="POST">
				{% csrf_token %}
				<input type="hidden" name="order_id" value="{{ order.id }}">
				<button type="submit" class="btn btn-success btn-block">
					<i class="fas fa-money-bill-wave"></i> Cash on Delivery
				</button>
			</form>
		</div> <!-- card-body.// -->
		</div> <!-- card.// -->

	</aside> <!-- col.// -->
</div> <!-- row.// -->

<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .// -->
</section>

<script>
  // var total = {{ grand_total }};
// Render the PayPal button into #paypal-button-container
paypal.Buttons({
    style: {
        color: 'blue',
        shape: 'rect',
        label: 'paypal',
        height: 40,
        tagline: false
    },

    // Set up the transaction
    createOrder: function(data, actions) {
        return actions.order.create({
            purchase_units: [{
                amount: {
                    value: 'amount'
                }
            }]
        });
    },

    // Finalize the transaction
    onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
            // Show a success message to the buyer
          console.log(details);
sendData();

function sendData() {
    fetch(url, {
        method: "POST",
        headers: {
            "Content-type": "application/json",
            "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
            orderID: orderID,
            transID: details.id,
            payment_method: payment_method,
            status: details.status,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          window .location.href = redirect_url+'?order_number='+data.order_number+'&transID='+data.transID;
        });
}

            
        });
    }

}).render('#paypal-button-container');
</script>
{% endblock %}
